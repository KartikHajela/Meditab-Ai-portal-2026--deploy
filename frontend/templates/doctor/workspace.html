{% from "doctor/macro/ai_chat.html" import render_ai_chat %}
{% from "doctor/macro/med_manager.html" import render_med_manager %}

<div id="view-workspace" class="view-container" style="display:none; padding:0; height:100%;">
    <div class="workspace-layout">
        
        <div class="ws-sidebar custom-scroll" style="overflow-y:auto;">
            <div class="patient-card" style="background:var(--bg-body);">
                <div style="display:flex; align-items:center; gap:12px; margin-bottom:16px;">
                    <div class="avatar-lg" style="width:64px; height:64px; border-radius:12px; background:#4f46e5; color:white; font-size:1.5rem; display:flex; align-items:center; justify-content:center;">JD</div>
                    <div>
                        <div style="font-size:1.2rem; font-weight:700;">John Doe</div>
                        <div style="color:var(--text-sub); font-size:0.9rem;">ID: #101 â€¢ 54 Male</div>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div class="info-tile">
                        <span class="lbl">Heart Rate</span>
                        <span class="val danger">110 bpm</span>
                    </div>
                    <div class="info-tile">
                        <span class="lbl">BP</span>
                        <span class="val warning">150/95</span>
                    </div>
                </div>
            </div>

            <div class="panel-section" style="flex:1; display:flex; flex-direction:column; border-top:1px solid var(--border);">
                {{ render_ai_chat() }}
            </div>
        </div>

        <div class="ws-main custom-scroll">
            <div class="clinical-tabs">
                <button class="tab-btn active" onclick="app.switchTab('notes')">Clinical Notes</button>
                <button class="tab-btn" onclick="app.switchTab('rx')">Meds & Plan</button>
                <button class="tab-btn" onclick="app.switchTab('history')">Patient History</button>
            </div>

            <div id="tab-notes" class="tab-content active">
                <div class="editor-wrapper">
                    <div class="editor-toolbar">
                        <button class="tool-btn"><span class="material-symbols-rounded">format_bold</span></button>
                        <button class="tool-btn"><span class="material-symbols-rounded">format_list_bulleted</span></button>
                        <button class="tool-btn" style="margin-left:auto; color:var(--primary);" onclick="app.generateReportPreview()">
                            <span class="material-symbols-rounded">description</span> Generate Report
                        </button>
                    </div>
                    <textarea id="clinicalNoteInput" class="clinical-textarea" placeholder="Enter findings (SOAP format)...">
Subjective: Patient reports acute chest pain (8/10)...
Objective: Diaphoretic, Tachycardic...
Assessment: Suspected ACS.
Plan: See Rx tab.
                    </textarea>
                </div>
            </div>

            <div id="tab-rx" class="tab-content">
                {{ render_med_manager() }}
            </div>

            <div style="padding:20px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:12px;">
                <button class="modal-btn secondary" onclick="app.navTo('dashboard')">Save Draft</button>
                <button class="modal-btn primary" onclick="app.finalizeCase()">
                    <span class="material-symbols-rounded">check_circle</span> Discharge & Sign
                </button>
            </div>
        </div>
    </div>
</div>

<div id="reportModal" class="modal-overlay" style="display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.8); position:fixed; inset:0; z-index:9000;">
    <div class="modal-box" style="width:600px; height:80vh; display:flex; flex-direction:column;">
        <div class="modal-header" style="display:flex; justify-content:space-between; padding-bottom:16px; border-bottom:1px solid var(--border);">
            <h3>Final Medical Report Preview</h3>
            <span class="material-symbols-rounded" style="cursor:pointer" onclick="document.getElementById('reportModal').style.display='none'">close</span>
        </div>
        <div class="modal-body custom-scroll" style="flex:1; overflow-y:auto; padding:20px; background:#f9fafb; font-family:'Times New Roman', serif;">
            <div style="text-align:center; margin-bottom:20px;">
                <h2>MEDITAB MEDICAL CENTER</h2>
                <p>123 Health Blvd, Wellness City</p>
            </div>
            <hr>
            <div id="reportContent"></div> </div>
        <div class="modal-footer" style="padding-top:16px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:10px;">
            <button class="modal-btn primary" onclick="app.printReport()">Print / PDF</button>
        </div>
    </div>
</div>