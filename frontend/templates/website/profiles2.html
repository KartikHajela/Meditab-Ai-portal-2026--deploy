<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="{{ url_for('static', path='media/favicon.ico') }}">
    <meta charset="UTF-8">
    <title>Profile Settings - Meditab</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', path='css/home_styles.css') }}">
    <style>
        .profile-container { max-width: 800px; margin: 40px auto; width: 90%; animation: fadeIn 0.4s ease-out; }
        .section-card { background: var(--bg-sidebar); border: 1px solid var(--border); border-radius: 16px; padding: 24px; margin-bottom: 24px; }
        .card-header { font-size: 1.1rem; font-weight: 600; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; color: var(--text-main); }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .form-group.full { grid-column: 1 / -1; }
        label { font-size: 0.85rem; font-weight: 500; color: var(--text-sub); }
        .form-input, .form-select { padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-body); color: var(--text-main); font-family: inherit; transition: 0.2s; }
        .form-input:focus { border-color: #4285f4; box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1); }
        .save-btn { background: #0b57d0; color: white; border: none; padding: 12px 30px; border-radius: 50px; font-weight: 500; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 8px; margin-left: auto; }
        .save-btn:hover { box-shadow: 0 4px 12px rgba(11, 87, 208, 0.3); transform: translateY(-1px); }
        /* Progress Bar */
        .completion-bar { height: 6px; background: var(--border); border-radius: 10px; overflow: hidden; margin: 10px 0 30px 0; }
        .completion-fill { height: 100%; background: linear-gradient(90deg, #d96570, #9b72cb, #4285f4); width: 0%; transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); }
        .completion-text { font-size: 0.85rem; color: var(--text-sub); display: flex; justify-content: space-between; margin-bottom: 5px; }
    </style>
</head>
<body>
    <div class="app-layout">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="brand-title">
                    <svg class="brand-logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 182 182"><path d="M91 0C40.7 0 0 40.7 0 91s40.7 91 91 91 91-40.7 91-91S141.3 0 91 0z" fill="currentColor"/></svg>
                    <span>Meditab</span>
                </div>
            </div>
            <a href="{{ '/portal/doctor/' + user_hash if user_role == 'DOCTOR' else '/app/' + user_hash }}" class="emergency-btn" style="background:transparent; border:1px solid var(--border); color:var(--text-main); margin-bottom:10px;">
                <span class="material-symbols-outlined">arrow_back</span> Back to Home
            </a>
        </aside>

        <main class="main-content custom-scroll" style="overflow-y: auto;">
            <div class="profile-container">
                <div class="greeting-section" style="margin-bottom: 10px;">
                    <h1 class="gradient-text">Profile Settings</h1>
                </div>

                <div class="completion-text">
                    <span>Profile Completion</span>
                    <span id="completionPercent">0%</span>
                </div>
                <div class="completion-bar">
                    <div class="completion-fill" id="completionFill"></div>
                </div>

                <form id="profileForm" onsubmit="saveProfile(event, '{{ user_id }}')">
                    <div class="section-card">
                        <div class="card-header"><span class="material-symbols-outlined">person</span> Personal Information</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Full Name</label>
                                <input type="text" name="full_name" class="form-input" value="{{ profile.full_name or '' }}" placeholder="John Doe">
                            </div>
                            <div class="form-group">
                                <label>Phone Number</label>
                                <input type="tel" name="phone" class="form-input" value="{{ profile.phone or '' }}" placeholder="+1 234 567 890">
                            </div>
                            
                            {% if user_role == 'DOCTOR' %}
                            <div class="form-group full">
                                <label>Professional Bio</label>
                                <textarea name="bio" class="form-input" rows="3" placeholder="Brief description of your expertise...">{{ doctor_profile.bio or '' }}</textarea>
                            </div>
                            {% else %}
                            <div class="form-group">
                                <label>Date of Birth</label>
                                <input type="date" name="date_of_birth" class="form-input" value="{{ profile.date_of_birth or '' }}">
                            </div>
                            <div class="form-group">
                                <label>Gender</label>
                                <select name="gender" class="form-select">
                                    <option value="">Select...</option>
                                    <option value="Male" {% if profile.gender == 'Male' %}selected{% endif %}>Male</option>
                                    <option value="Female" {% if profile.gender == 'Female' %}selected{% endif %}>Female</option>
                                    <option value="Other" {% if profile.gender == 'Other' %}selected{% endif %}>Other</option>
                                </select>
                            </div>
                            <div class="form-group full">
                                <label>Address</label>
                                <textarea name="address" class="form-input" rows="2" placeholder="123 Health St, Wellness City">{{ profile.address or '' }}</textarea>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    {% if user_role == 'DOCTOR' %}
                    <div class="section-card">
                        <div class="card-header"><span class="material-symbols-outlined">medical_services</span> Professional Details</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Specialty</label>
                                <select name="specialty" class="form-select">
                                    {% for spec in specialties %}
                                    <option value="{{ spec.value }}" {% if doctor_profile.specialty == spec %}selected{% endif %}>{{ spec.value }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Availability Status</label>
                                <select name="is_available" class="form-select">
                                    <option value="true" {% if doctor_profile.is_available %}selected{% endif %}>Available for Cases</option>
                                    <option value="false" {% if not doctor_profile.is_available %}selected{% endif %}>Busy / Offline</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <button type="submit" class="save-btn">
                        <span class="material-symbols-outlined">save</span> Save Changes
                    </button>
                </form>
            </div>
        </main>
    </div>

    <script>
        function calculateCompletion() {
            const inputs = document.querySelectorAll('input, select, textarea');
            let filled = 0; let total = 0;
            inputs.forEach(input => {
                if(input.type === 'hidden' || input.type === 'submit') return;
                total++;
                if(input.value.trim() !== '') filled++;
            });
            const percent = Math.round((filled / total) * 100);
            document.getElementById('completionFill').style.width = percent + '%';
            document.getElementById('completionPercent').innerText = percent + '%';
        }
        calculateCompletion();
        document.querySelectorAll('input, select, textarea').forEach(el => {
            el.addEventListener('input', calculateCompletion);
        });

        async function saveProfile(e, userId) {
            e.preventDefault();
            const btn = document.querySelector('.save-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Saving...';
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            if(data.is_available) data.is_available = data.is_available === 'true';

            try {
                // Post to /users/{user_id}/profile/update
                const res = await fetch(`/users/${userId}/profile/update`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                if(res.ok) {
                    btn.innerHTML = '<span class="material-symbols-outlined">check</span> Saved!';
                    btn.style.backgroundColor = '#1e8e3e';
                    setTimeout(() => { btn.innerHTML = originalText; btn.style.backgroundColor = ''; }, 2000);
                } else {
                    alert("Save failed");
                }
            } catch(err) {
                console.error(err);
                alert("Error connecting to server");
            }
            btn.innerHTML = originalText;
        }
    </script>
</body>
</html>